---

apiVersion: batch/v1
kind: Job
metadata:
  name: transformd-embargo-new
  labels:
    app: transformd
spec:
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        app: transformd
    spec:
      restartPolicy: Never
      containers:
      - name: efdtransform
        image: "ghcr.io/lsst-dm/consdb-efdtransform:placeholder"
        imagePullPolicy: Always
        command: ["/bin/bash"]
        args: ["-c", "source loadLSST.bash; setup lsst_distrib; python /opt/lsst/software/stack/python/lsst/consdb/efd_transform/transform_efd.py -c \"$CONFIG_FILE\" -i \"$INSTRUMENT\" -r \"$BUTLER_REPO\" -d \"$CONSDB_URL\"  -E \"$EFD\" -t \"$TIMEDELTA\" -w \"$TIMEWINDOW\" -l \"$LOG_FILE\" -s \"$DATETIME_START\" -e \"$DATETIME_END\" -m \"$MODE\" -R"]
        env:
        - name: CONFIG_FILE 
          value: /opt/lsst/software/stack/python/lsst/consdb/efd_transform/config_LSSTComCam.yaml
        - name: INSTRUMENT
          value: LSSTComCam
        - name: TIMEDELTA
          value: "15"
        - name : TIMEWINDOW
          value: "5"          
        - name: DATETIME_START
          value: "2024-10-22T00:00:00"
        - name: DATETIME_END
          value: "2025-01-01T00:00:00"
        - name: MODE
          value: "job"          
        - name: CONSDB_URL
          valueFrom:
            secretKeyRef:
              name: efd-transform-db
              key: consdb-url
        - name: EFD_USERNAME
          value: "efdreader"
        - name: EFD_PASSWORD
          valueFrom:
            secretKeyRef:
              name: usdf-efd
              key: usdf-efd-password
        - name: BUTLER_REPO
          value: "s3://embargo@rubin-summit-users/butler.yaml"
        - name: S3_ENDPOINT_URL
          value: https://s3dfrgw.slac.stanford.edu/
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: s3
              key: access-key-id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: s3
              key: secret-access-key
        - name: LSST_RESOURCES_S3_PROFILE_embargo
          valueFrom:
            secretKeyRef:
              name: s3
              key: s3-profile-embargo
        - name: PGUSER
          value: rubin
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres
              key: butler-password              
        - name: LOG_FILE
          value: "/opt/lsst/software/stack/data/transform.log"              
        resources:
          limits:
            cpu: "4"
            memory: "8Gi"
          requests:
            cpu: "2"
            memory: "4Gi"

